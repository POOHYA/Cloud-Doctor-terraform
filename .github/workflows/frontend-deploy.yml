name: Frontend Deploy to Private Subnet

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'frontend/**'

# 1ï¸âƒ£ OIDC ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 2ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3ï¸âƒ£ AWS OIDC ì¸ì¦ (Access Key ì—†ì´ Role ARN ì‚¬ìš©)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 4ï¸âƒ£ Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 5ï¸âƒ£ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Install dependencies and build
        working-directory: frontend/cloud-doctor
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_AUDIT_API_URL: ${{ secrets.REACT_APP_AUDIT_API_URL }}
        run: |
          npm ci
          CI=false npm run build

      # 6ï¸âƒ£ ë¹Œë“œ íŒŒì¼ ì••ì¶• (./build ì•ˆì˜ ë‚´ìš©ë§Œ ì••ì¶•)
      - name: Create build archive
        run: |
          cd frontend/cloud-doctor/build
          tar -czf ../../../build.tar.gz .
          # ë£¨íŠ¸ ê²½ë¡œë¡œ ì••ì¶•íŒŒì¼ ì´ë™ í™•ì¸

      # 7ï¸âƒ£ Bastion ì„œë²„ë¡œ ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ
      - name: Copy build files to Bastion
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "build.tar.gz"
          target: "/home/ubuntu/"

      # 8ï¸âƒ£ Bastionì—ì„œ 2ëŒ€ì˜ Private EC2ë¡œ ìˆœì°¨ ë°°í¬
      - name: Deploy on Multiple Private EC2 via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ IP ë¦¬ìŠ¤íŠ¸ ì •ì˜ (Secretsì— ë“±ë¡ í•„ìš”)
            FE_SERVERS=("${{ secrets.FE_SERVER_1_IP }}" "${{ secrets.FE_SERVER_2_IP }}")
            
            for IP in "${FE_SERVERS[@]}"; do
              echo "------------------------------------------------"
              echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ë°°í¬ ì‹œì‘: $IP"
              echo "------------------------------------------------"

              # 1. Bastionì—ì„œ í•´ë‹¹ Private EC2ë¡œ ì••ì¶• íŒŒì¼ ì „ì†¡
              scp -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no /home/ubuntu/build.tar.gz ubuntu@$IP:/home/ubuntu/

              # 2. í•´ë‹¹ Private EC2 ë‚´ë¶€ ì ‘ì† í›„ Nginx ê²½ë¡œì— ë°°í¬
              ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@$IP << 'EOF'
                # ì„ì‹œ ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
                mkdir -p ~/temp_build
                
                # ì••ì¶• í•´ì œ
                tar -xzf ~/build.tar.gz -C ~/temp_build/
                
                # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë° ìƒˆ íŒŒì¼ ë³µì‚¬ (ê¶Œí•œ ìœ ì§€ ìœ„í•´ sudo ì‚¬ìš©)
                sudo rm -rf /var/www/html/*
                sudo cp -r ~/temp_build/* /var/www/html/
                
                # Nginxê°€ ì½ì„ ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ì„¤ì •
                sudo chown -R www-data:www-data /var/www/html
                sudo chmod -R 755 /var/www/html
                
                # Nginx ì„¤ì • ë°˜ì˜ (ì¬ì‹œì‘ë³´ë‹¤ ê°€ë²¼ìš´ reload)
                sudo systemctl reload nginx
                
                # ì •ë¦¬
                rm -f ~/build.tar.gz
                rm -rf ~/temp_build
            EOF
              echo "âœ… ì„œë²„ ë°°í¬ ì™„ë£Œ: $IP"
              sleep 5
            done
