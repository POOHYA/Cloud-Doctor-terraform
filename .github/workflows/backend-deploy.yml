name: Backend Deploy (ECR)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PGSQL_URL: ${{ secrets.PGSQL_URL }}
      PGSQL_USERNAME: ${{ secrets.PGSQL_USERNAME }}
      PGSQL_PASSWORD: ${{ secrets.PGSQL_PASSWORD }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      ACCESS_TOKEN_EXPIRATION: ${{ secrets.ACCESS_TOKEN_EXPIRATION }}
      REFRESH_TOKEN_EXPIRATION: ${{ secrets.REFRESH_TOKEN_EXPIRATION }}
      COOKIE_SECURE: true
      INFRAAUDIT_API_URL: ${{ secrets.INFRAAUDIT_API_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. AWS OIDC Ïù∏Ï¶ù
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 2. AWS ECR Î°úÍ∑∏Ïù∏
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. JAR ÎπåÎìú
      - name: Build JAR
        working-directory: backend/CloudDoctorWeb
        run: ./gradlew clean build -x test

      # 4. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è ECR Ìë∏Ïãú
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_BE_REPO_NAME }} # Ïòà: cloud-doctor-backend
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./backend/CloudDoctorWeb
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # 5. BastionÏùÑ ÌÜµÌï¥ Í∞Å Private ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨ Î™ÖÎ†π Ï†ÑÎã¨
      - name: Deploy to Multiple Private EC2 via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            SERVER_IPS=("${{ secrets.BE_SERVER_1_IP }}" "${{ secrets.BE_SERVER_2_IP }}")
            
            for IP in "${SERVER_IPS[@]}"; do
              echo "üöÄ $IP ÏÑúÎ≤ÑÏóê ECR Ïù¥ÎØ∏ÏßÄ Î∞∞Ìè¨ Ï§ë..."
              
              ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@$IP << 'EOF'
                # 1. ECR Î°úÍ∑∏Ïù∏ (EC2 Ïù∏Ïä§ÌÑ¥Ïä§ ÌîÑÎ°úÌååÏùº Í∂åÌïú ÌïÑÏöî)
                aws ecr get-login-password --region ap-northeast-2 | sudo docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
                
                # 2. ÏµúÏã† Ïù¥ÎØ∏ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
                sudo docker pull ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_BE_REPO_NAME }}:latest
                
                # 3. Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è ÏÇ≠Ï†ú
                sudo docker stop cloud-doctor-backend || true
                sudo docker rm cloud-doctor-backend || true
                
                # 4. ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
                sudo docker run -d -p 9090:9090 \
                  -e PGSQL_URL="${{ secrets.PGSQL_URL }}" \
                  -e PGSQL_USERNAME="${{ secrets.PGSQL_USERNAME }}" \
                  -e PGSQL_PASSWORD="${{ secrets.PGSQL_PASSWORD }}" \
                  -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
                  -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
                  -e REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}" \
                  -e ACCESS_TOKEN_EXPIRATION="${{ secrets.ACCESS_TOKEN_EXPIRATION }}" \
                  -e REFRESH_TOKEN_EXPIRATION="${{ secrets.REFRESH_TOKEN_EXPIRATION }}" \
                  -e COOKIE_SECURE=true \
                  -e INFRAAUDIT_API_URL="${{ secrets.INFRAAUDIT_API_URL }}" \
                  --restart unless-stopped \
                  --name cloud-doctor-backend \
                  ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_BE_REPO_NAME }}:latest
                
                # 5. ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Ïò§ÎûòÎêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
                sudo docker image prune -f
            EOF
              echo "‚úÖ ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏôÑÎ£å: $IP"
              sleep 5
            done
