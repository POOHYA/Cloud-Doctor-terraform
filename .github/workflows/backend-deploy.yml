name: Backend Deploy (ECR + ASG)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. AWS OIDC ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 2. AWS ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. JAR ë¹Œë“œ
      - name: Build JAR
        working-directory: backend/CloudDoctorWeb
        run: ./gradlew clean build -x test

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_BE_REPO_NAME }}
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./backend/CloudDoctorWeb
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # 5. Bastion ì ‘ì† í›„ ASG ë‚´ ì¸ìŠ¤í„´ìŠ¤ IP ìŠ¤ìº” ë° ìˆœì°¨ ë°°í¬
      - name: Deploy to Dynamic ASG Instances via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # ASG ì´ë¦„ì„ Secretsì—ì„œ ê°€ì ¸ì˜´
            ASG_NAME="${{ secrets.BE_ASG_NAME }}"
            ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
            REPO_NAME="${{ secrets.ECR_BE_REPO_NAME }}"
            
            echo "ğŸ” ASG [$ASG_NAME]ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ëŠ” ì¤‘..."
            
            # 1. í˜„ì¬ InService ìƒíƒœì¸ ì¸ìŠ¤í„´ìŠ¤ ID ì¡°íšŒ
            INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --region ap-northeast-2 \
              --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
              --output text)
            
            if [ -z "$INSTANCE_IDS" ] || [ "$INSTANCE_IDS" == "None" ]; then
              echo "âŒ ë°°í¬ ê°€ëŠ¥í•œ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # 2. ì¸ìŠ¤í„´ìŠ¤ IDë¡œ Private IP ì¶”ì¶œ
            SERVER_IPS=$(aws ec2 describe-instances \
              --instance-ids $INSTANCE_IDS \
              --region ap-northeast-2 \
              --query 'Reservations[*].Instances[*].PrivateIpAddress' \
              --output text)

            echo "ğŸ“ ì°¾ì•„ë‚¸ ë°°í¬ ëŒ€ìƒ IP: $SERVER_IPS"

            # 3. ê° IPë³„ë¡œ ìˆœì°¨ ë°°í¬
            for IP in $SERVER_IPS; do
              echo "------------------------------------------------"
              echo "ğŸš€ ë°±ì—”ë“œ ì„œë²„ ë°°í¬ ì‹œì‘: $IP"
              echo "------------------------------------------------"
              
              ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@$IP << EOF
                # ECR ë¡œê·¸ì¸
                aws ecr get-login-password --region ap-northeast-2 | sudo docker login --username AWS --password-stdin $ECR_REGISTRY
                
                # ìµœì‹  ì´ë¯¸ì§€ Pull
                sudo docker pull $ECR_REGISTRY/$REPO_NAME:latest
                
                # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
                sudo docker stop cloud-doctor-backend || true
                sudo docker rm cloud-doctor-backend || true
                
                # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í™˜ê²½ë³€ìˆ˜ ì£¼ì…)
                sudo docker run -d -p 9090:9090 \
                  -e PGSQL_URL="${{ secrets.PGSQL_URL }}" \
                  -e PGSQL_USERNAME="${{ secrets.PGSQL_USERNAME }}" \
                  -e PGSQL_PASSWORD="${{ secrets.PGSQL_PASSWORD }}" \
                  -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
                  -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
                  -e REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}" \
                  -e ACCESS_TOKEN_EXPIRATION="${{ secrets.ACCESS_TOKEN_EXPIRATION }}" \
                  -e REFRESH_TOKEN_EXPIRATION="${{ secrets.REFRESH_TOKEN_EXPIRATION }}" \
                  -e COOKIE_SECURE=true \
                  -e INFRAAUDIT_API_URL="${{ secrets.INFRAAUDIT_API_URL }}" \
                  --restart unless-stopped \
                  --name cloud-doctor-backend \
                  $ECR_REGISTRY/$REPO_NAME:latest
                  
                # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
                sudo docker image prune -f
            EOF
              echo "âœ… ì„œë²„ ë°°í¬ ì™„ë£Œ: $IP"
              sleep 5
            done
