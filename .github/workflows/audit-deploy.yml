name: Python Backend Deploy (ECR + ASG)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'infraaudit/**'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. AWS OIDC ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 2. AWS ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_PYTHON_REPO_NAME }}
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./infraaudit
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # 4. Bastion ì ‘ì† í›„ ASG ë‚´ ì¸ìŠ¤í„´ìŠ¤ IP ìŠ¤ìº” ë° ë°°í¬
      - name: Deploy to Dynamic ASG Instances via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # ASG ì´ë¦„ì„ Secretsì—ì„œ ê°€ì ¸ì˜´
            ASG_NAME="${{ secrets.PYTHON_ASG_NAME }}"
            ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
            REPO_NAME="${{ secrets.ECR_PYTHON_REPO_NAME }}"
            
            echo "ğŸ” ASG [$ASG_NAME]ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ëŠ” ì¤‘..."
            
            # 1. í˜„ì¬ InService ìƒíƒœì¸ ì¸ìŠ¤í„´ìŠ¤ IDë“¤ ì¡°íšŒ
            INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --region ap-northeast-2 \
              --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
              --output text)
            
            if [ -z "$INSTANCE_IDS" ] || [ "$INSTANCE_IDS" == "None" ]; then
              echo "âŒ ë°°í¬ ê°€ëŠ¥í•œ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # 2. ì¸ìŠ¤í„´ìŠ¤ IDë¡œ Private IP ì¶”ì¶œ
            SERVER_IPS=$(aws ec2 describe-instances \
              --instance-ids $INSTANCE_IDS \
              --region ap-northeast-2 \
              --query 'Reservations[*].Instances[*].PrivateIpAddress' \
              --output text)

            echo "ğŸ“ ë°°í¬ ëŒ€ìƒ IP: $SERVER_IPS"

            # 3. ê° IPë³„ë¡œ ìˆœì°¨ ë°°í¬
            for IP in $SERVER_IPS; do
              echo "ğŸš€ ì„œë²„ ë°°í¬ ì‹œì‘: $IP"
              
              ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@$IP << EOF
                # ECR ë¡œê·¸ì¸
                aws ecr get-login-password --region ap-northeast-2 | sudo docker login --username AWS --password-stdin $ECR_REGISTRY
                
                # ì´ë¯¸ì§€ Pull ë° ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
                sudo docker pull $ECR_REGISTRY/$REPO_NAME:latest
                sudo docker stop infraaudit-backend || true
                sudo docker rm infraaudit-backend || true
                
                sudo docker run -d -p 8000:8000 \
                  --restart unless-stopped \
                  --name infraaudit-backend \
                  $ECR_REGISTRY/$REPO_NAME:latest
                  
                # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
                sudo docker image prune -f
            EOF
              echo "âœ… ì„œë²„ ë°°í¬ ì™„ë£Œ: $IP"
              sleep 5
            done
