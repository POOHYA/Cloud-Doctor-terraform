name: Python Backend Deploy (ECR)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'infraaudit/**'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. AWS OIDC ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 2. AWS ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_PYTHON_REPO_NAME }} # ECR ë ˆí¬ì§€í† ë¦¬ ì´ë¦„
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./infraaudit
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # 4. Bastionì„ í†µí•´ Private EC2ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ëª…ë ¹ ì „ë‹¬
      - name: Deploy to Private EC2 via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # ì„œë²„ IP ë¦¬ìŠ¤íŠ¸ (ALB ëŒ€ì‘ì„ ìœ„í•´ ë°˜ë³µë¬¸ ì‚¬ìš©)
            SERVER_IPS=("${{ secrets.PYTHON_SERVER_1_IP }}" "${{ secrets.PYTHON_SERVER_2_IP }}")
            
            for IP in "${SERVER_IPS[@]}"; do
              echo "ğŸš€ $IP ì„œë²„ì— ECR ì´ë¯¸ì§€ ë°°í¬ ì¤‘..."
              
              ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@$IP << 'EOF'
                # ECR ë¡œê·¸ì¸ (ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼ ê¶Œí•œ í•„ìš”)
                aws ecr get-login-password --region ap-northeast-2 | sudo docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
                
                # ìµœì‹  ì´ë¯¸ì§€ í’€
                sudo docker pull ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_PYTHON_REPO_NAME }}:latest
                
                # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
                sudo docker stop infraaudit-backend || true
                sudo docker rm infraaudit-backend || true
                
                # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                # OIDC ì„ì‹œ í‚¤ ëŒ€ì‹  'IAM ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼'ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë³´ì•ˆìƒ í›¨ì”¬ ì¢‹ìŠµë‹ˆë‹¤.
                sudo docker run -d -p 8000:8000 \
                  --restart unless-stopped \
                  --name infraaudit-backend \
                  ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_PYTHON_REPO_NAME }}:latest
              EOF
            done
